<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin | Add / Edit Member</title>

<style>
body {
  font-family: Arial, sans-serif;
  background:#111;
  color:#fff;
  margin:0;
  padding:20px;
}

.card {
  max-width:520px;
  margin:auto;
  background:#1c1c1c;
  padding:25px;
  border-radius:14px;
  box-shadow:0 0 20px rgba(0,0,0,.8);
}

label {
  display:block;
  margin-top:14px;
  font-size:14px;
  opacity:.8;
}

input, select, textarea, button {
  width:100%;
  margin-top:6px;
  padding:12px;
  border-radius:8px;
  border:none;
  font-size:15px;
}

textarea {
  resize:vertical;
  min-height:70px;
}

button {
  margin-top:18px;
  font-weight:bold;
  background:#caa24d;
  cursor:pointer;
}

button:hover { background:#e0b85a; }

.secondary {
  background:#2ecc71;
  margin-top:10px;
}

.secondary:hover { background:#27ae60; }

.viewBtn {
  background:#3498db;
}

.hidden { display:none; }

small {
  opacity:.6;
}
</style>
</head>

<body>

<div class="card">
  <h2 id="title">Add Member</h2>

  <label>Full Name</label>
  <input id="fullname">

  <label>Alexis / Medusa Name</label>
  <input id="alexis">

  <label>GT</label>
  <input id="gt">

  <label>Date Survive</label>
  <input type="date" id="date">

  <label>Status</label>
  <select id="status">
    <option>ACTIVE</option>
    <option>INACTIVE</option>
  </select>

  <label>Position</label>
  <select id="position">
    <option>Current GT</option>
    <option>Former GT</option>
    <option>Organizer</option>
    <option>MKS</option>
    <option>MKC</option>
    <option>Member</option>
    <option>Adviser</option>
    <option>7 Master</option>
  </select>

  <label>Remarks</label>
  <textarea id="remarks"></textarea>

  <label>Photo</label>
  <input type="file" id="photo" accept="image/*">

  <label>Certificate of Legitimacy</label>
  <input type="file" id="col" accept=".pdf,.jpg,.png">

  <button id="viewCOL" class="viewBtn hidden">View Certificate of Legitimacy</button>

  <label>Other Certificates</label>
  <input type="file" id="others" multiple accept=".pdf,.jpg,.png">

  <button id="viewOthers" class="viewBtn hidden">View Other Certificates</button>

  <button onclick="save()">Save Member</button>
  <button class="secondary" onclick="generateID()">Generate ID</button>

  <small id="msg"></small>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzm9kXBRRFWT60ngW0VjQoDZba4ynjrE2E1Cw23Ybb1783FuTLl7P9K6mrrYZS3gwg_/exec";

const params = new URLSearchParams(location.search);
const mode = params.get("mode") || "add";
const token = params.get("token") || "";

const el = id => document.getElementById(id);

const fullname = el("fullname");
const alexis   = el("alexis");
const gt       = el("gt");
const date     = el("date");
const status   = el("status");
const position = el("position");
const remarks  = el("remarks");
const photo    = el("photo");
const col      = el("col");
const others   = el("others");
const msg      = el("msg");
const viewCOL  = el("viewCOL");
const viewOthers = el("viewOthers");

if(mode === "edit"){
  el("title").innerText = "Edit Member";
  loadMember();
}

function loadMember(){
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({ action:"getMember", token })
  })
  .then(r=>r.json())
  .then(m=>{
    fullname.value = m.fullname || "";
    alexis.value   = m.alexis || "";
    gt.value       = m.gt || "";
    date.value     = m.date || "";
    status.value   = m.status || "ACTIVE";
    position.value = m.position || "";
    remarks.value  = m.remarks || "";

    if(m.col){
      viewCOL.classList.remove("hidden");
      viewCOL.onclick = ()=>window.open(m.col);
    }

    if(m.others){
      viewOthers.classList.remove("hidden");
      viewOthers.onclick = ()=>{
        m.others.split("|").forEach(l=>window.open(l));
      };
    }
  });
}

function readFile(file){
  return new Promise(res=>{
    const r = new FileReader();
    r.onload = ()=>res(r.result);
    r.readAsDataURL(file);
  });
}

async function save(){
  msg.innerText = "Savingâ€¦";

  let photo64 = "";
  let col64 = "";
  let other64 = [];

  if(photo.files[0]) photo64 = await readFile(photo.files[0]);
  if(col.files[0]) col64 = await readFile(col.files[0]);

  if(others.files.length){
    for(let f of others.files){
      other64.push(await readFile(f));
    }
  }

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"saveMember",
      mode,
      token,
      fullname:fullname.value,
      alexis:alexis.value,
      gt:gt.value,
      date:date.value,
      status:status.value,
      position:position.value,
      remarks:remarks.value,
      photoBase64:photo64,
      colURL:col64,
      otherCerts:other64.join("|")
    })
  })
  .then(r=>r.json())
  .then(res=>{
    msg.innerText = res.success ? "Saved successfully" : "Error saving";
    if(res.success) setTimeout(()=>location.href="admin-dashboard.html",1200);
  });
}

function generateID(){
  alert("ID generation next step");
}
</script>

</body>
</html>
